<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notion Tree - Select Page</title>
  <link rel="stylesheet" href="css/home.css">
</head>

<body>
  <div class="header">
    <h1>ğŸŒ¿ ë£¨íŠ¸ í˜ì´ì§€ ì„ íƒ</h1>
    <div class="subtitle">íŠ¸ë¦¬ë¡œ ë§Œë“¤ Notion í˜ì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
  </div>

  <div id="pageList">
    <!-- Loading state -->
    <div style="text-align:center; color: white; font-weight:bold;">í˜ì´ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>

  <button id="reselectBtn">
    ë¡œê·¸ì¸ ë‹¤ì‹œ í•˜ê¸°
  </button>

  <script>
    async function loadPages() {
      try {
        const res = await fetch("/api/pages", { credentials: "include" });
        const data = await res.json();

        const container = document.getElementById("pageList");
        container.innerHTML = "";

        if (!data.results || data.results.length === 0) {
          container.innerHTML = '<div style="text-align:center; background:white; padding:20px; border-radius:10px;">í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        data.results.forEach(page => {
          const title = page.properties?.title?.title?.[0]?.plain_text || "(ì œëª© ì—†ìŒ)";
          const pageId = page.id.replace(/-/g, "");
          const icon = page.icon?.emoji || "ğŸ“„"; // Use emoji icon if available, else default

          const btn = document.createElement("button");
          btn.className = "page-card";
          btn.innerHTML = `<span class="icon">${icon}</span><span>${title}</span>`;
          btn.onclick = () => selectDirectory(pageId);

          container.appendChild(btn);
        });
      } catch (err) {
        console.error(err);
        const container = document.getElementById("pageList");
        container.innerHTML = '<div style="text-align:center; background:white; padding:20px; border-radius:10px; color:red;">í˜ì´ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    }

    async function selectDirectory(pageId) {
      try {
        await fetch("/api/select-directory", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ pageId })
        });
        window.location.href = "/tree.html";
      } catch (err) {
        alert("í˜ì´ì§€ ì„ íƒ ì‹¤íŒ¨");
      }
    }

    document.getElementById("reselectBtn").onclick = () => {
      window.location.href = "/";
    };

    loadPages();
  </script>
</body>

</html>