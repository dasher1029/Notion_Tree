<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>트리 렌더링 페이지</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .node circle { fill: #8ecae6; stroke: #023047; stroke-width: 2px; } 
    .link { fill: none; stroke: #999; stroke-width: 1.5px; } 
  </style>
</head>
<body>
  <div id="status" style="font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: 14px; margin: 8px 0;">Loading...</div>
  <svg width="800" height="600"></svg>

  <script>
    // --- Client-side D3 renderer that binds API data dynamically ---

    // 1) Basic references
    const statusEl = document.getElementById("status");
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    // 2) Render function: receives { name, children[] } and draws the tree
    function renderTree(data) {
      // Clear previous drawing (if any)
      svg.selectAll("*").remove();

      // Prepare viewport
      svg.attr("viewBox", [0, 0, width, height]);

      // Build hierarchy and layout coordinates
      const root = d3.hierarchy(data);
      const treeLayout = d3.tree().size([height, width - 200]);
      treeLayout(root); // mutates root with x/y positions

      // Links
      svg.selectAll(".link")
        .data(root.links())
        .enter().append("path")
        .attr("class", "link")
        .attr("d", d3.linkHorizontal()
          .x(d => d.y)
          .y(d => d.x));

      // Nodes
      const node = svg.selectAll(".node")
        .data(root.descendants())
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.y},${d.x})`);

      node.append("circle").attr("r", 6);
      node.append("text")
        .attr("dy", 3)
        .attr("x", d => d.children ? -10 : 10)
        .style("text-anchor", d => d.children ? "end" : "start")
        .text(d => d.data?.name ?? "(no name)");
    }

    // 3) Fetch tree data from your Express API and bind it into the renderer
    async function loadAndRender() {
      try {
        statusEl.textContent = "Loading tree...";
        // IMPORTANT: include credentials so cookies (access_token, session) are sent
        const res = await fetch("/api/tree", { credentials: "include" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        // Optional sanity checks to help with debugging
        if (!data || typeof data !== "object") {
          throw new Error("Invalid payload: expected an object");
        }
        if (!("name" in data)) {
          console.warn("Missing 'name' in root data; assigning default.");
          data.name = data.name ?? "Workspace";
        }
        if (!("children" in data)) {
          console.warn("Missing 'children' array; assigning empty list.");
          data.children = data.children ?? [];
        }

        renderTree(data);
        statusEl.textContent = ""; // clear status on success
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to load tree. Check console for details.";
      }
    }

    // 4) Kick off when the page is ready
    document.addEventListener("DOMContentLoaded", loadAndRender);
  </script>
</body>
</html>